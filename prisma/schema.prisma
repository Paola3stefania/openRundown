// Prisma schema for UNMute MCP Database
// Generated from existing migrations

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Channel {
  id        String   @id
  name      String?
  guildId   String?  @map("guild_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  classifiedThreads ClassifiedThread[]
  groups            Group[]
  ungroupedThreads  UngroupedThread[]
  history           ClassificationHistory[]
  messages          DiscordMessage[]
  exportResults     ExportResult[]

  @@index([guildId])
  @@map("channels")
}

model ClassifiedThread {
  threadId              String   @id @map("thread_id")
  channelId             String   @map("channel_id")
  threadName            String?  @map("thread_name")
  messageCount          Int      @default(1) @map("message_count")
  firstMessageId        String?  @map("first_message_id")
  firstMessageAuthor    String?  @map("first_message_author")
  firstMessageTimestamp DateTime? @map("first_message_timestamp")
  firstMessageUrl       String?  @map("first_message_url")
  classifiedAt          DateTime @default(now()) @map("classified_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  status                String   @default("completed") // 'pending' | 'classifying' | 'completed' | 'failed'
  matchStatus           String?  @map("match_status") // 'matched' | 'below_threshold' | 'no_matches' | null (not classified yet)
  exportStatus          String?  @map("export_status") // 'pending' | 'exported' | null (not exported yet)
  exportedAt            DateTime? @map("exported_at")
  resolutionStatus      String?  @map("resolution_status") // 'conversation_resolved' | null (not resolved)
  resolvedAt            DateTime? @map("resolved_at")
  linearIssueId         String?  @map("linear_issue_id")
  linearIssueUrl        String?  @map("linear_issue_url")
  linearIssueIdentifier String?  @map("linear_issue_identifier")

  channel      Channel             @relation(fields: [channelId], references: [id], onDelete: Cascade)
  issueMatches ThreadIssueMatch[]
  groupThreads GroupThread[]
  ungrouped    UngroupedThread?
  history      ClassificationHistory[]
  embedding    ThreadEmbedding?

  @@index([channelId])
  @@index([status])
  @@index([matchStatus])
  @@index([exportStatus])
  @@index([resolutionStatus])
  @@map("classified_threads")
}

model ThreadIssueMatch {
  id              Int      @id @default(autoincrement())
  threadId        String   @map("thread_id")
  issueNumber     Int      @map("issue_number")
  issueTitle      String   @map("issue_title")
  issueUrl        String   @map("issue_url")
  issueState      String?  @map("issue_state")
  similarityScore Decimal  @map("similarity_score") @db.Decimal(5, 2)
  matchedTerms    String[] @map("matched_terms")
  issueLabels     String[] @map("issue_labels")
  issueAuthor     String?  @map("issue_author")
  issueCreatedAt  DateTime? @map("issue_created_at")
  createdAt       DateTime @default(now()) @map("created_at")

  thread ClassifiedThread @relation(fields: [threadId], references: [threadId], onDelete: Cascade)

  @@unique([threadId, issueNumber])
  @@index([threadId])
  @@index([issueNumber])
  @@index([similarityScore(sort: Desc)])
  @@map("thread_issue_matches")
}

model Group {
  id                    String    @id
  channelId             String    @map("channel_id")
  githubIssueNumber     Int?      @map("github_issue_number")
  suggestedTitle        String    @map("suggested_title")
  avgSimilarity         Decimal?  @map("avg_similarity") @db.Decimal(5, 2)
  threadCount           Int       @default(0) @map("thread_count")
  isCrossCutting        Boolean   @default(false) @map("is_cross_cutting")
  status                String    @default("pending") // 'pending' | 'exported'
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  exportedAt            DateTime? @map("exported_at")
  linearIssueId         String?   @map("linear_issue_id")
  linearIssueUrl        String?   @map("linear_issue_url")
  linearIssueIdentifier String?   @map("linear_issue_identifier")
  linearProjectIds      String[]  @map("linear_project_ids")
  affectsFeatures       Json      @default("[]") @map("affects_features")

  channel      Channel       @relation(fields: [channelId], references: [id], onDelete: Cascade)
  groupThreads GroupThread[]
  githubIssues  GitHubIssue[] // Issues in this group
  embedding    GroupEmbedding?

  @@index([channelId])
  @@index([status])
  @@index([githubIssueNumber])
  @@index([affectsFeatures], type: Gin)
  @@map("groups")
}

model GroupThread {
  id              Int      @id @default(autoincrement())
  groupId         String   @map("group_id")
  threadId        String   @map("thread_id")
  similarityScore Decimal? @map("similarity_score") @db.Decimal(5, 2)
  createdAt       DateTime @default(now()) @map("created_at")

  group   Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  thread  ClassifiedThread @relation(fields: [threadId], references: [threadId], onDelete: Cascade)

  @@unique([groupId, threadId])
  @@index([groupId])
  @@index([threadId])
  @@map("group_threads")
}

model UngroupedThread {
  threadId            String   @id @map("thread_id")
  channelId           String   @map("channel_id")
  reason              String   // 'no_matches' | 'below_threshold'
  topIssueNumber      Int?     @map("top_issue_number")
  topIssueTitle       String?  @map("top_issue_title")
  topIssueSimilarity  Decimal? @map("top_issue_similarity") @db.Decimal(5, 2)
  exportStatus        String?  @map("export_status") // 'pending' | 'exported' | null (not exported yet)
  exportedAt          DateTime? @map("exported_at")
  linearIssueId       String?  @map("linear_issue_id")
  linearIssueUrl      String?  @map("linear_issue_url")
  linearIssueIdentifier String? @map("linear_issue_identifier")
  resolutionStatus    String?  @map("resolution_status") // 'closed_issue' | 'conversation_resolved' | null (not resolved/closed)
  resolvedAt          DateTime? @map("resolved_at")
  affectsFeatures     Json     @default("[]") @map("affects_features")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  channel Channel          @relation(fields: [channelId], references: [id], onDelete: Cascade)
  thread  ClassifiedThread @relation(fields: [threadId], references: [threadId], onDelete: Cascade)

  @@index([channelId])
  @@index([reason])
  @@index([exportStatus])
  @@index([affectsFeatures], type: Gin)
  @@map("ungrouped_threads")
}

model ClassificationHistory {
  id          Int       @id @default(autoincrement())
  channelId   String    @map("channel_id")
  messageId   String    @map("message_id")
  threadId    String?   @map("thread_id")
  classifiedAt DateTime @default(now()) @map("classified_at")

  channel Channel? @relation(fields: [channelId], references: [id], onDelete: Cascade)
  thread  ClassifiedThread? @relation(fields: [threadId], references: [threadId], onDelete: Cascade)

  @@unique([channelId, messageId])
  @@map("classification_history")
}

model GitHubIssue {
  issueNumber          Int      @id @map("issue_number")
  issueTitle           String   @map("issue_title")
  issueUrl             String   @map("issue_url")
  issueState           String?  @map("issue_state")
  issueBody            String?  @map("issue_body")
  issueLabels          String[] @map("issue_labels")
  issueAuthor          String?  @map("issue_author")
  issueCreatedAt       DateTime? @map("issue_created_at")
  issueUpdatedAt       DateTime? @map("issue_updated_at")
  
  // Full conversation data
  issueComments        Json     @default("[]") @map("issue_comments") // Array of comment objects
  issueAssignees       String[] @map("issue_assignees") // Array of assignee usernames
  issueMilestone       String?  @map("issue_milestone") // Milestone title
  issueReactions       Json?    @map("issue_reactions") // Reactions object
  
  // Group tracking
  groupId              String?  @map("group_id") // FK to groups table (inGroup is redundant - groupId null = not in group)
  
  // Thread matching
  matchedToThreads     Boolean  @default(false) @map("matched_to_threads")
  
  // Feature matching (issue-centric)
  affectsFeatures      Json     @default("[]") @map("affects_features") // Array of {id, name} objects
  
  // LLM-detected labels (bug, security, regression, enhancement, urgent)
  detectedLabels       String[] @default([]) @map("detected_labels")
  
  // Export status
  exportStatus         String?  @map("export_status") // 'pending' | 'exported' | null (not exported yet)
  exportedAt           DateTime? @map("exported_at")
  linearIssueId        String?  @map("linear_issue_id")
  linearIssueUrl       String?  @map("linear_issue_url")
  linearIssueIdentifier String? @map("linear_issue_identifier")
  
  // Linear sync status
  linearStatus         String?  @map("linear_status") // 'backlog' | 'todo' | 'in_progress' | 'done' | 'canceled'
  linearStatusSyncedAt DateTime? @map("linear_status_synced_at")
  closedByPR           String?  @map("closed_by_pr") // PR number/URL that closed this issue (legacy, use pullRequests relation)
  closedByPRMergedAt   DateTime? @map("closed_by_pr_merged_at")
  
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  group                Group?   @relation(fields: [groupId], references: [id])
  embedding            IssueEmbedding?
  threadMatches        IssueThreadMatch[] // Issue-centered thread matches
  pullRequests         GitHubPullRequest[] // PRs that reference this issue

  @@index([matchedToThreads])
  @@index([exportStatus])
  @@index([issueState])
  @@index([groupId])
  @@index([issueAssignees], type: Gin)
  @@index([linearStatus])
  @@index([linearIssueId])
  @@map("github_issues")
}

// GitHub Pull Requests
model GitHubPullRequest {
  prNumber             Int      @id @map("pr_number")
  prTitle               String   @map("pr_title")
  prUrl                 String   @unique @map("pr_url")
  prState               String   @map("pr_state") // "open" | "closed"
  prMerged              Boolean  @default(false) @map("pr_merged")
  prAuthor              String   @map("pr_author") // GitHub username
  prCreatedAt           DateTime @map("pr_created_at")
  prUpdatedAt           DateTime @map("pr_updated_at")
  prBody                String?  @map("pr_body")
  prHeadRef             String?  @map("pr_head_ref")
  prBaseRef             String?  @map("pr_base_ref")
  
  // Relations
  linkedIssues          GitHubIssue[] // Issues that this PR references
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([prState])
  @@index([prMerged])
  @@index([prAuthor])
  @@map("github_pull_requests")
}

// Issue-centered thread matches (GitHub issue is primary, Discord threads are attached)
model IssueThreadMatch {
  id              Int      @id @default(autoincrement())
  issueNumber     Int      @map("issue_number")
  threadId        String   @map("thread_id")
  threadName      String?  @map("thread_name")
  threadUrl       String?  @map("thread_url")
  similarityScore Decimal  @map("similarity_score") @db.Decimal(5, 2) // 0-100 scale
  matchMethod     String   @default("embedding") @map("match_method") // 'embedding' | 'keyword' | 'manual'
  messageCount    Int      @default(0) @map("message_count")
  firstMessageAt  DateTime? @map("first_message_at")
  lastMessageAt   DateTime? @map("last_message_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  issue           GitHubIssue @relation(fields: [issueNumber], references: [issueNumber], onDelete: Cascade)

  @@unique([issueNumber, threadId])
  @@index([issueNumber])
  @@index([threadId])
  @@index([similarityScore(sort: Desc)])
  @@index([matchMethod])
  @@map("issue_thread_matches")
}

model IssueEmbedding {
  issueNumber Int      @id @map("issue_number")
  embedding   Json     // Array of floats (1536 dimensions)
  contentHash String   @map("content_hash")
  model       String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  issue GitHubIssue @relation(fields: [issueNumber], references: [issueNumber], onDelete: Cascade)

  @@index([contentHash])
  @@index([model])
  @@map("issue_embeddings")
}

model ThreadEmbedding {
  threadId    String   @id @map("thread_id")
  embedding   Json     // Array of floats (1536 dimensions)
  contentHash String   @map("content_hash")
  model       String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  thread ClassifiedThread @relation(fields: [threadId], references: [threadId], onDelete: Cascade)

  @@index([contentHash])
  @@index([model])
  @@map("thread_embeddings")
}

model GroupEmbedding {
  groupId     String   @id @map("group_id")
  embedding   Json     // Array of floats (1536 dimensions)
  contentHash String   @map("content_hash")
  model       String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([contentHash])
  @@index([model])
  @@map("group_embeddings")
}

model DocumentationCache {
  url       String   @id
  title     String?
  content   String
  fetchedAt DateTime @default(now()) @map("fetched_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sections      DocumentationSection[]
  embeddings    DocumentationEmbedding?
  sectionEmbeddings DocumentationSectionEmbedding[]

  @@index([fetchedAt(sort: Desc)])
  @@map("documentation_cache")
}

model DocumentationSection {
  id              Int      @id @default(autoincrement())
  documentationUrl String  @map("documentation_url")
  title           String
  content         String
  sectionUrl      String?  @map("section_url")
  sectionOrder    Int      @default(0) @map("section_order")
  createdAt       DateTime @default(now()) @map("created_at")

  documentation DocumentationCache @relation(fields: [documentationUrl], references: [url], onDelete: Cascade)
  embedding      DocumentationSectionEmbedding?

  @@index([documentationUrl])
  @@index([documentationUrl, sectionOrder])
  @@map("documentation_sections")
}

model DocumentationSectionEmbedding {
  sectionId       Int      @id @map("section_id")
  documentationUrl String  @map("documentation_url")
  embedding       Json     // Array of floats (1536 dimensions)
  contentHash     String   @map("content_hash")
  model           String
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  section      DocumentationSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  documentation DocumentationCache  @relation(fields: [documentationUrl], references: [url], onDelete: Cascade)

  @@index([documentationUrl])
  @@index([contentHash])
  @@index([model])
  @@map("documentation_section_embeddings")
}

model DocumentationEmbedding {
  documentationUrl String   @id @map("documentation_url")
  embedding        Json     // Array of floats (1536 dimensions)
  contentHash      String   @map("content_hash")
  model            String
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  documentation DocumentationCache @relation(fields: [documentationUrl], references: [url], onDelete: Cascade)

  @@index([contentHash])
  @@index([model])
  @@map("documentation_embeddings")
}

model Feature {
  id                  String   @id
  name                String
  description         String?
  category            String?
  priority            String?
  relatedKeywords     String[] @map("related_keywords")
  documentationSection String? @map("documentation_section")
  documentationUrls   String[] @map("documentation_urls")
  codeContext         String?  @db.Text @map("code_context")
  extractedAt         DateTime @default(now()) @map("extracted_at")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  embedding FeatureEmbedding?
  codeMappings FeatureCodeMapping[]

  @@index([name])
  @@index([category])
  @@index([priority])
  @@index([relatedKeywords], type: Gin)
  @@index([documentationUrls], type: Gin)
  @@index([extractedAt(sort: Desc)])
  @@map("features")
}

model FeatureEmbedding {
  featureId   String   @id @map("feature_id")
  embedding   Json     // Array of floats (1536 dimensions)
  contentHash String   @map("content_hash")
  model       String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@index([contentHash])
  @@index([model])
  @@map("feature_embeddings")
}

// Lazy code indexing - only index code when searched/needed
model CodeSearch {
  id            String   @id // Hash of search query + repo
  searchQuery   String   @map("search_query") // e.g., "SSO authentication"
  repositoryUrl String   @map("repository_url") // GitHub repo URL
  searchType    String   @map("search_type") // 'semantic', 'keyword', 'exact'
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  codeFiles     CodeFile[]
  
  @@unique([searchQuery, repositoryUrl])
  @@index([repositoryUrl])
  @@index([createdAt(sort: Desc)])
  @@map("code_searches")
}

model CodeFile {
  id            String   @id
  codeSearchId  String   @map("code_search_id")
  filePath      String   @map("file_path")
  fileName      String   @map("file_name")
  fileContent   String   @db.Text @map("file_content") // Full file content
  language      String?  // ts, js, py, etc.
  contentHash   String   @map("content_hash") // To detect changes
  lastIndexedAt DateTime @default(now()) @map("last_indexed_at")
  indexedAt     DateTime @default(now()) @map("indexed_at")
  
  codeSearch    CodeSearch      @relation(fields: [codeSearchId], references: [id], onDelete: Cascade)
  codeSections  CodeSection[]
  embeddings    CodeFileEmbedding?
  
  @@unique([codeSearchId, filePath])
  @@index([codeSearchId])
  @@index([filePath])
  @@index([contentHash])
  @@index([lastIndexedAt])
  @@map("code_files")
}

model CodeSection {
  id            String   @id
  codeFileId    String   @map("code_file_id")
  sectionType   String   @map("section_type") // 'function', 'class', 'interface', 'type', 'export'
  sectionName   String   @map("section_name") // Function/class name
  sectionContent String  @db.Text @map("section_content") // Just this section's code
  startLine     Int?     @map("start_line")
  endLine       Int?     @map("end_line")
  contentHash   String   @map("content_hash")
  createdAt     DateTime @default(now()) @map("created_at")
  
  codeFile      CodeFile         @relation(fields: [codeFileId], references: [id], onDelete: Cascade)
  embedding     CodeSectionEmbedding?
  featureMappings FeatureCodeMapping[]
  
  @@index([codeFileId])
  @@index([sectionType])
  @@index([sectionName])
  @@index([contentHash])
  @@map("code_sections")
}

model CodeFileEmbedding {
  codeFileId   String   @id @map("code_file_id")
  embedding    Json     // Array of floats (1536 dimensions) - embedding of entire file
  contentHash  String   @map("content_hash")
  model        String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  codeFile     CodeFile @relation(fields: [codeFileId], references: [id], onDelete: Cascade)
  
  @@index([contentHash])
  @@index([model])
  @@map("code_file_embeddings")
}

model CodeSectionEmbedding {
  codeSectionId String   @id @map("code_section_id")
  embedding     Json     // Array of floats (1536 dimensions) - embedding of this section
  contentHash   String   @map("content_hash")
  model         String
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  codeSection   CodeSection @relation(fields: [codeSectionId], references: [id], onDelete: Cascade)
  
  @@index([contentHash])
  @@index([model])
  @@map("code_section_embeddings")
}

model FeatureCodeMapping {
  id            String   @id
  featureId     String   @map("feature_id")
  codeSectionId String   @map("code_section_id")
  similarity    Decimal  @db.Decimal(5, 4) // 0.0-1.0 cosine similarity
  matchType     String   @map("match_type") // 'semantic', 'keyword', 'exact'
  searchQuery   String?  @map("search_query") // Original search that found this
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  feature    Feature    @relation(fields: [featureId], references: [id], onDelete: Cascade)
  codeSection CodeSection @relation(fields: [codeSectionId], references: [id], onDelete: Cascade)
  
  @@unique([featureId, codeSectionId])
  @@index([featureId])
  @@index([codeSectionId])
  @@index([similarity(sort: Desc)])
  @@index([matchType])
  @@map("feature_code_mappings")
}

model UngroupedIssue {
  issueNumber          Int      @id @map("issue_number")
  issueTitle           String   @map("issue_title")
  issueUrl             String   @map("issue_url")
  issueState           String?  @map("issue_state")
  issueBody            String?  @map("issue_body")
  issueLabels          String[] @map("issue_labels")
  issueAuthor          String?  @map("issue_author")
  issueCreatedAt       DateTime? @map("issue_created_at")
  exportStatus         String?  @map("export_status") // 'pending' | 'exported' | null (not exported yet)
  exportedAt           DateTime? @map("exported_at")
  linearIssueId        String?  @map("linear_issue_id")
  linearIssueUrl       String?  @map("linear_issue_url")
  linearIssueIdentifier String? @map("linear_issue_identifier")
  affectsFeatures      Json     @default("[]") @map("affects_features")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@index([exportStatus])
  @@index([issueState])
  @@index([affectsFeatures], type: Gin)
  @@map("ungrouped_issues")
}

model DiscordMessage {
  id              String   @id
  channelId       String   @map("channel_id")
  authorId        String   @map("author_id")
  authorUsername  String?  @map("author_username")
  authorDiscriminator String? @map("author_discriminator")
  authorBot       Boolean  @default(false) @map("author_bot")
  authorAvatar    String?  @map("author_avatar")
  content         String   @db.Text
  createdAt       DateTime @map("created_at")
  editedAt        DateTime? @map("edited_at")
  timestamp       String   // Discord timestamp as string
  channelName     String?  @map("channel_name")
  guildId         String?  @map("guild_id")
  guildName       String?  @map("guild_name")
  attachments     Json     @default("[]") // Array of attachment objects
  embeds          Int      @default(0)
  mentions        String[] // Array of user IDs
  reactions       Json     @default("[]") // Array of reaction objects
  threadId        String?  @map("thread_id")
  threadName      String?  @map("thread_name")
  messageReference Json?   @map("message_reference") // Reference object or null
  url             String?  @map("url")
  fetchedAt       DateTime @default(now()) @map("fetched_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([authorId])
  @@index([createdAt])
  @@index([threadId])
  @@index([guildId])
  @@map("discord_messages")
}

model ExportResult {
  id                String   @id
  channelId         String?  @map("channel_id")
  pmTool           String   @map("pm_tool")
  sourceFile       String?  @map("source_file")
  success          Boolean  @default(false)
  featuresExtracted Int     @default(0) @map("features_extracted")
  featuresMapped   Int     @default(0) @map("features_mapped")
  issuesCreated    Int     @default(0) @map("issues_created")
  issuesUpdated    Int     @default(0) @map("issues_updated")
  issuesSkipped    Int     @default(0) @map("issues_skipped")
  errors           Json    @default("[]")
  exportMappings   Json?   @map("export_mappings") // Stores group_export_mappings, ungrouped_thread_export_mappings, etc.
  closedItemsCount Json?   @map("closed_items_count") // Stores closed_items_count data
  closedItemsFile  String? @map("closed_items_file")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  channel Channel? @relation(fields: [channelId], references: [id], onDelete: SetNull)

  @@index([channelId])
  @@index([pmTool])
  @@index([success])
  @@index([createdAt(sort: Desc)])
  @@map("export_results")
}

